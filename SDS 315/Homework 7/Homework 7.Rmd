---
title: "Homework 4"
output: html_document
date: "2/13/2025"
---

Kaustubh Duddala
[Github](https://github.com/kaustubhduddala/StatisticsAndDataScience/tree/main/SDS%20315/Homework%204)

```{r, include=FALSE}
library(ggplot2)
library(tidyverse)
library(mosaic)
library(knitr)
library(kableExtra)
```

## Problem 1    

Are the observed data (70 flagged trades out of 2021) consistent with the SEC’s null hypothesis that, over
the long run, securities trades from the Iron Bank are flagged at the same 2.4% baseline rate as that of other
traders?

#### Iron Bank
```{r, message=FALSE, echo=FALSE}

p1_iron_bank_fraud <- rbinom(n = 10000, size = 2021, prob = 0.024)
p1_pvalue = mean(p1_iron_bank_fraud >= 70)

cat("p value:", p1_pvalue)

hist(p1_iron_bank_fraud, main="Distribution of simulated flagged trades under null hypothesis", xlab = "Number of flagged trades")

```

The null hypothesis is that the Iron Bank's trades are flagged at the same 2.4% rate as other traders. The test statistic is the number of flagged trades. The p-value is 0.0019.  Based on this p-value, the null hypothesis is rejected.

## Problem 2

Are the observed data for Gourmet Bites consistent with the Health Department’s null hypothesis that, on average, restaurants in the city are cited for health code violations at the same 3% baseline rate?

#### Health Inspections
```{r, message=FALSE, echo=FALSE}

p2_health <- rbinom(n = 100000, size = 50, prob = 0.03)
p2_pvalue = mean(p2_health >= 8)

cat("P value:", p2_pvalue)

hist(p2_health, main="Distribution of simulated health code violations under null hypothesis", xlab = "Number of health code violations")

```

The null hypothesis is that Gourmet Bites is cited for health code violations at the same 3% rate as other restaurants. The test statistic is the number of violations. The p-value is 0.00014. Based on this p-value, the null hypothesis rejected.

## Problem 3

Determine whether the distribution of jurors empaneled by this judge is significantly different from the county’s population proportions. If so, does this suggest systematic bias in jury selection? What other explanations might exist, and how could you investigate further?

#### Health Inspections
```{r, message=FALSE, echo=FALSE}

observed_counts <- c(85, 56, 59, 27, 13)
total_jurors <- sum(observed_counts)

expected_proportions <- c(0.30, 0.25, 0.20, 0.15, 0.10)

expected_counts <- expected_proportions * total_jurors

chi_squared_test <- chisq.test(observed_counts, p = expected_proportions)

print(chi_squared_test)

p3_pvalue <- chi_squared_test$p.value

cat("P-value:", p3_pvalue, "\n")

```

The null hypothesis is that the jury selection reflects the county's population proportions.  The test statistic is the Chi-squared statistic. The p-value is 0.01445.  Based on this p-value, the null hypothesis is rejected. If significant, it suggests bias, but other explanations could include random variation or differences in exemption rates. Further investigation could involve analyzing data from other judges and examining the reasons for juror excusals.

## Problem 4

One was generated by an LLM with a watermark based on a frequency shift idea. Can you tell which sentence it is?

#### Part A: the null or reference distribution
```{r, message=FALSE, echo=FALSE}
p4d_letter <- read_csv("letter_frequencies.csv")
p4d_brown <- readLines("brown_sentences.txt")

clean <- function(text, freq_table) {
  word <- str_replace_all(text, "[^A-Za-z]", "") %>% toupper()
  obs_val <- table(factor(strsplit(word, "")[[1]], levels = freq_table$Letter))
  total <- sum(obs_val)
  expect_val <- total * freq_table$Probability
  
  chi_test <- sum((obs_val - expect_val)^2 / expect_val)
  return(chi_test)
}

p4d_letter$Probability <- p4d_letter$Probability / sum(p4d_letter$Probability)
chi_val <- sapply(p4d_brown, clean, freq_table = p4d_letter)  
hist(chi_val, main = "Distribution of Chi-squared Values for sentences", xlab = "Chi-squared Statistic", breaks = 50)

```

#### Part B: checking for a watermark
```{r, message=FALSE, echo=FALSE}

p4d_sentences <- c(
"She opened the book and started to read the first chapter, eagerly anticipating what might come next.",
"Despite the heavy rain, they decided to go for a long walk in the park, crossing the main avenue by the fountain in the center.",
"The museum’s new exhibit features ancient artifacts from various civilizations around the world.",
"He carefully examined the document, looking for any clues that might help solve the mystery.",
"The students gathered in the auditorium to listen to the guest speaker’s inspiring lecture.",
"Feeling vexed after an arduous and zany day at work, she hoped for a peaceful and quiet evening at home, cozying up after a quick dinner with some TV, or maybe a book on her upcoming visit to Auckland.",
"The chef demonstrated how to prepare a delicious meal using only locally sourced ingredients, focusing mainly on some excellent dinner recipes from Spain.",
"They watched the sunset from the hilltop, marveling at the beautiful array of colors in the sky.",
"The committee reviewed the proposal and provided many points of useful feedback to improve the project’s effectiveness.",
"Despite the challenges faced during the project, the team worked tirelessly to ensure its successful completion, resulting in a product that exceeded everyone’s expectations."
)
```

```{r, message=FALSE, echo=FALSE}
watermark_chi <- sapply(p4d_sentences, clean, freq_table = p4d_letter)
pvals <- sapply(watermark_chi, \(x) mean(chi_val >= x, na.rm = TRUE))

results_table <- as_tibble(data.frame(
  Sentence = 1:10,
  Chi_Squared = round(watermark_chi, 1),
  P_value = round(pvals, digits = 3) %>% format.pval(eps = 0.0001, digits = 3)
)) %>% select(starts_with("S"):last_col())

results_table

```

The results strongly indicate that Sentence 6 contains an LLM watermark. Its letter frequency distribution deviates significantly from natural English patterns, a sign of algorithmic text generation with frequency-based watermarks. 